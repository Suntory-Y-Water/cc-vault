name: Weekly Article Summary Trigger

on:
  schedule:
    # æ¯é€±æ—¥æ›œ 15:00 UTC (æœˆæ›œ 00:00 JST)
    - cron: '0 15 * * 0'
  workflow_dispatch:
    inputs:
      start_date:
        description: 'é–‹å§‹æ—¥ (YYYY-MM-DD)'
        required: true
        type: string
      end_date:
        description: 'çµ‚äº†æ—¥ (YYYY-MM-DD)'
        required: true
        type: string

defaults:
  run:
    shell: bash

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  actions-security:
    permissions:
      contents: read
      security-events: write
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run actionlint
        uses: koki-develop/github-actions-lint/actionlint@62dfef5c9854a07712bad7af3bee7edb0c1109b1 # v1.4.1

      - name: Run ghalint
        uses: koki-develop/github-actions-lint/ghalint@62dfef5c9854a07712bad7af3bee7edb0c1109b1 # v1.4.1

  create-weekly-summary-issue:
    needs: [actions-security]
    if: always() && needs.actions-security.result == 'success'
    permissions:
      contents: read
      issues: write
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      TZ: Asia/Tokyo
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set date range
        env:
          START_DATE_INPUT: ${{ github.event.inputs.start_date }}
          END_DATE_INPUT: ${{ github.event.inputs.end_date }}
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            # å‰é€±ã®æœˆæ›œæ—¥ã‹ã‚‰æ—¥æ›œæ—¥ã‚’è¨ˆç®—ï¼ˆJSTï¼‰
            START_DATE=$(date -d "last monday -7 days" +%Y-%m-%d)
            END_DATE=$(date -d "${START_DATE} +6 days" +%Y-%m-%d)
          else
            START_DATE="${START_DATE_INPUT}"
            END_DATE="${END_DATE_INPUT}"
          fi
          
          echo "START_DATE=${START_DATE}" >> "${GITHUB_ENV}"
          echo "END_DATE=${END_DATE}" >> "${GITHUB_ENV}"
          echo "ğŸ“… å‡¦ç†æœŸé–“: ${START_DATE} ï½ ${END_DATE}"

      - name: Read prompt template
        id: read-prompt
        run: |
          PROMPT_CONTENT=$(cat .github/prompts/weekly-summary.md)
          {
            echo "PROMPT_CONTENT<<EOF"
            echo "$PROMPT_CONTENT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Weekly Summary Issue
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        env:
          PROMPT_CONTENT: ${{ steps.read-prompt.outputs.PROMPT_CONTENT }} 
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const startDate = process.env.START_DATE;
            const endDate = process.env.END_DATE;
            const promptContent = process.env.PROMPT_CONTENT; 
            
            const title = `é€±æ¬¡è¨˜äº‹è¦ç´„ç”Ÿæˆ: ${startDate} - ${endDate}`;
            
            const body = `${promptContent}\n\n## å‡¦ç†æœŸé–“\n- é–‹å§‹æ—¥: ${startDate}\n- çµ‚äº†æ—¥: ${endDate}\n\n@claude ä¸Šè¨˜ã®æŒ‡ç¤ºã«å¾“ã£ã¦é€±æ¬¡è¨˜äº‹è¦ç´„ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;

            const response = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['weekly-summary', 'claude-action']
            });
            
            console.log('Issue created: ' + response.data.html_url);
