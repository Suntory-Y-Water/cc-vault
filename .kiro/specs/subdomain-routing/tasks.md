# 実装計画

- [ ] 1. データベース基盤の構築とAIエージェント設定システムの確立
- [x] 1.1 データベーススキーマにAIエージェント識別カラムを追加
  - articlesテーブルに`ai_agent`カラムを追加して既存データとの互換性を保持
  - デフォルト値'claude-code'を設定して既存記事がclaude-codeで表示されるよう設定
  - ai_agentカラムに対するインデックスを作成してクエリパフォーマンスを最適化
  - マイグレーションスクリプトを実装して安全なスキーマ更新を実行
  - _Requirements: 2.1, 2.2, 2.3_

- [x] 1.2 静的AIエージェント設定システムを構築
  - AIエージェント設定用の型定義システムを実装してタイプセーフな設定管理を実現
  - クロード・コード、コデックス、デフォルトエージェントの設定ファイルを作成
  - 各エージェントのブランディング情報（色、名称、説明）を定義
  - エージェント別のコンテンツフィルタリング設定を構築
  - _Requirements: 5.1, 5.2_

- [ ] 1.3 ホスト名ベースのテナント解決システムを実装
  - ホスト名からサブドメインを抽出してAIエージェント識別子を特定する機能を構築
  - サブドメインとAIエージェント設定のマッピングシステムを実装
  - 未知のサブドメインに対するデフォルトエージェントへのフォールバック機能を追加
  - ホスト名検証とサニタイゼーション機能を実装してセキュリティを確保
  - _Requirements: 1.1, 1.2, 1.3, 7.1_

- [ ] 2. Next.jsレイアウトシステムでのマルチテナント対応実装
- [ ] 2.1 ルートレイアウトにサブドメイン検出機能を統合
  - Next.js headers APIを使用してリクエストホスト名を取得する機能を実装
  - サーバーコンポーネントでのAIエージェント識別処理を構築
  - レイアウトコンポーネントにAIエージェント情報を伝播する仕組みを実装
  - data-ai-agent属性をHTMLルート要素に設定してCSSスコープを確立
  - _Requirements: 1.1, 1.4_

- [ ] 2.2 UIテーマとブランディングの動的適用システムを構築
  - AIエージェント別のCSSカスタムプロパティシステムを実装
  - data-ai-agent属性を使用したCSSスコープでの色とスタイリング適用
  - エージェント別のサイト名とタグラインの動的表示機能を実装
  - デフォルトテーマへのグレースフルデグレデーション機能を追加
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [ ] 3. データアクセス層でのテナント別フィルタリング実装
- [ ] 3.1 記事取得機能にAIエージェントフィルタリングを統合
  - 既存のgetArticlesWithPagination関数にaiAgentパラメータを追加
  - Drizzle ORMクエリにWHERE句でのai_agentフィルタリングを実装
  - テナント識別子の自動クエリフィルター追加機能を構築
  - 既存のページネーション機能との互換性を維持
  - _Requirements: 2.1, 4.1_

- [ ] 3.2 検索とフィルタリング機能のテナントスコープ対応
  - 検索機能にテナント別スコープフィルタリングを適用
  - サイト別フィルタリング機能との組み合わせでのAIエージェント制限を実装
  - カテゴリフィルターのテナント関連カテゴリのみ表示機能を構築
  - 既存のソート機能との統合でテナント境界を維持
  - _Requirements: 4.2, 4.4_

- [ ] 3.3 週次レポート生成のテナント別対応実装
  - 週次レポート生成時のテナント別コンテンツフィルタリングを実装
  - AIエージェント専用のトレンド分析とレポート作成機能を構築
  - テナント別のトップ記事選出システムを実装
  - AI要約機能でのテナントスコープ内コンテンツ分析を実現
  - _Requirements: 4.3_

- [ ] 4. ページコンポーネントでのマルチテナント表示実装
- [ ] 4.1 ホームページでのAIエージェント別記事表示機能を実装
  - page.tsxサーバーコンポーネントでのAIエージェント識別とデータ取得
  - 記事一覧コンポーネントへのフィルタ済みデータ渡し機能を実装
  - 既存のMainTabsコンポーネントとの統合でエージェント別表示を実現
  - ページネーション機能でのテナント境界維持を確保
  - _Requirements: 4.1_

- [ ] 4.2 検索ページでのテナント別検索結果表示を実装
  - 検索ページでのAIエージェント情報取得とスコープ設定
  - 検索結果のテナント内フィルタリング表示機能を構築
  - 検索ボックスコンポーネントとの統合でエージェント制限を実現
  - 検索結果のページネーションでテナント境界を維持
  - _Requirements: 4.2_

- [ ] 4.3 週次レポートページでのエージェント専用コンテンツ表示
  - 週次レポートページでのAIエージェント別データ取得とフィルタリング
  - トップ記事表示のテナント別コンテンツ制限を実装
  - 週選択ナビゲーションでのエージェントスコープ維持を確保
  - レポート生成時のテナント専用分析結果表示を実現
  - _Requirements: 4.3_

- [ ] 5. セキュリティとパフォーマンス最適化の実装
- [ ] 5.1 テナント分離セキュリティ機能を実装
  - ホスト名検証とサニタイゼーション機能を全エンドポイントに適用
  - テナント権限チェック機能をデータアクセス層に統合
  - 不正なテナントアクセス検出とログ記録システムを実装
  - API エンドポイントでのテナント境界検証を強制実行
  - _Requirements: 7.1, 7.2, 7.3, 7.4_

- [ ] 5.2 キャッシュ戦略とパフォーマンス最適化を実装
  - テナント別の静的リソースキャッシュキー生成システムを構築
  - Next.js SSRでのテナント設定サーバーサイドキャッシュを実装
  - Cloudflare Workersエッジキャッシュのテナント対応を最適化
  - データベースクエリ結果のテナント別キャッシュシステムを構築
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 6. 統合テストとシステム検証の実装
- [ ] 6.1 ユニットテストでのコア機能検証を実装
  - AIエージェント設定解決関数のテストケースを作成
  - ホスト名パース機能の境界値テストを実装
  - データフィルタリング関数の正確性検証テストを構築
  - エラーハンドリング機能の堅牢性テストを実行
  - _Requirements: 全要件の品質保証_

- [ ] 6.2 統合テストでのエンドツーエンド機能検証を実装
  - ホスト名からAIエージェント解決の統合フローテストを作成
  - データベースフィルタリング機能の統合テストを実装
  - CSSスコープ適用とテーマ機能の統合テストを構築
  - マルチテナント環境でのデータ分離検証テストを実行
  - _Requirements: 全要件の統合検証_